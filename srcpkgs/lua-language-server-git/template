# Template file for 'lua-language-server'
_pkgname=lua-language-server
pkgname=${_pkgname}-git
version=0.0.0
revision=1
wrksrc=${_pkgname}
hostmakedepends="ninja git"
depends="lua"
short_desc="Lua Language Server coded by Lua"
maintainer="Gabriel Sanches <gabriel@gsr.dev>"
license="MIT"
homepage="https://github.com/sumneko/lua-language-server"
patch_args=-Np1

do_fetch() {
	git clone https://github.com/sumneko/${_pkgname}.git ${wrksrc}
	cd ${wrksrc}
	git submodule update --init --recursive
}

do_build() {
	cd ${wrksrc}/3rd/luamake
	ninja -f ninja/linux.ninja
	cd ../..
	./3rd/luamake/luamake rebuild
}

do_install() {
	vlicense LICENSE

	# main script
	vmkdir usr/lib/${_pkgname}
	vcopy "${wrksrc}/bin/Linux/*" usr/lib/${_pkgname}

	# entrypoint and files
	vmkdir usr/share/${_pkgname}
	for script in main.lua platform.lua debugger.lua locale script meta; do
		vcopy "${wrksrc}/${script}" usr/share/${_pkgname}
	done

	vmkdir usr/bin
	sed ${FILESDIR}/wrapper \
		-e "s;@PKGNAME@;$_pkgname;g" \
		> "${_pkgname}-wrapper"
	vbin "${_pkgname}-wrapper" $_pkgname
}
